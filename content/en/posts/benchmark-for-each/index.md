---
title: "Foreach loop vs performances"
date: 2024-05-13T00:00:00+00:00
draft: false
description: 
image: "posts/benchmark-for-each/preview.gif"
---

## Background
Benchmark on For, Javascript & Liquid template.
There is a bit of noise around how performant the Logic App for loop really is, 
Looping over an array and preforming operations on each item, is a quite common task.

We will conduct a benchmark between the Logic Apps,  action, inorder to get more insight on how the different methods perform.

## Exploring options For loops
Loop over an array of elements is one of bread and butter when it comes programming, in Logic Apps this is normally perform by the [For each](https://learn.microsoft.com/en-us/azure/logic-apps/logic-apps-control-flow-loops?tabs=consumption#foreach-loop) action. But there are many ways to interact with a collection such as [Inline code](https://learn.microsoft.com/en-us/azure/logic-apps/logic-apps-add-run-inline-code?tabs=consumption), [Liquid Transformation](https://learn.microsoft.com/en-us/azure/logic-apps/logic-apps-enterprise-integration-liquid-transform?tabs=consumption), [Data Operations](https://learn.microsoft.com/en-us/azure/logic-apps/logic-apps-perform-data-operations?tabs=consumption) and even [Expressions](https://learn.microsoft.com/en-us/azure/logic-apps/workflow-definition-language-functions-reference). Some of mentions actions are more limited and others are more free on what you can do, so depending on the operation you would like to perform some method might more suitable than others. 
For example if you would like to filter an collection based on property the Filter Actions is a good option, if you would like to reverse the order of in an array you can simply use the [reverse](https://learn.microsoft.com/en-us/azure/logic-apps/workflow-definition-language-functions-reference#reverse) Expression.

### For Each
This action allows you loop over a collection, by default iterations will run at the same time in parallel. There are limitation related to the For Each action depending on if you run Logic App Consumption or Standard. The devil is in the details, but generally the For Each can only loop over 100,000 items and the concurrency is by default set to `20` and with a max at `50`. Read more about the limitation [here](https://learn.microsoft.com/en-us/azure/logic-apps/logic-apps-limits-and-config?tabs=consumption#looping-debatching-limits).

### Filter Action
[Filter array]() action is apart of the Data Operations family, which allows you to create a subset of items based on a criteria. The action takes a collection as input and can filter the array on a property equal a specific value. The action can not transform the output into a different format or alter any items, instead these operations has to be done in a later actions.  

### Inline Code action
Allows you to run "vanilla" JavaScript code within Logic Apps and can be used for a vast variety of tasks. The action can utilize outputs from other actions and can also `return` the output of the code, which, in turn, can be used in other actions in your workflows.[üìñ](/posts/benchmark-condition/#inline-code-action)

## The Benchmark
This benchmark focus around on a use case where there is a need to filter a collection and adding a property on the subset of items. We will increase the amount of elements by 500, starting at 500 going up to 10,000 elements. The benchmark will be performed on three different implementations, each focusing on a different Logic App action:
- For Each with Condition
- Filter Array with For Each
- and Inline code

The files for this benchmark was generated by [dummy-data-cli](https://github.com/antonidag/dummy-data-cli). Its a tool built for generating dummy data based on JavaScript templates. The following template was used: 
```
export function main(index) {
    return `
    [
      {{#repeat ${index}}}
      {
        "id": {{@index}},
        "name": "{{firstName}} {{lastName}}",
        "work": "{{company}}",
        "email": "{{email}}",
        "dob": "{{date '1900' '2000' 'YYYY'}}",
        "address": "{{int 1 100}} {{street}}",
        "city": "{{city}}",
        "optedin": {{boolean}},
        "coordinates": {
          "x": {{float -50 50 '0.00'}},
          "y": {{float -25 25 '0.00'}}
        },
        "price": "$ {{int 0 99999 '0,0'}}",
        "status": "{{random 'active' 'inactive' 'paused' }}"
      }
      {{/repeat}}
    ]`
}
``` 

### Scenario Description:
1. **Read/Input Array**
2. **Loop Over Array:**
   - Once the array is retrieved, iterate over individual elements within the array.
3. **Conditional Handling:**
   - Filter out objects based on status equal to `active`
4. **Add/enrich elements with additional data**
  - Add `batchId` with a uuid string
5. **Return filtered array with enriched data**

The order of the operations is not necessarily needed to be followed, the important is that the input array is filtered and individual items are enriched with more data.

### Workflow implementation
For simplicity all the workflows will return back a `202 Accepted` to the client once a request is received, and allows for the rest of the workflow to continue its execution and process the payload. 

__For each__ uses a Condition inside of the For Each action 

![For each with Filter Array workflow](For_each.png)

__Filter Action with For each__ uses the Filter Array before looping over the elements with a For Each action

![For each with Filter Array workflow](For_each_with_FilterArray.png)

__Inline code__ using JavaScript to filter and loop over the collection

![JavaScript workflow](JavsScript.png)


Want more details, make sure to view my github [project](https://github.com/antonidag/logic-app-for-each-benchmark)!

### Environment settings
All the benchmarks will use the same resource setup: 
- WS1 App Service Plan. The scale out burst and minimum were set to 1 instances.
- Logic Apps Standard, scale out setting was set to 1 Always Ready Instances. 
- Workflow mode was set to the `Stateful` mode, and the concurrency settings remained at default, meaning that Logic App will process several elements simultaneously.

## Result

### Time per element in seconds
![Time_per_element_in_seconds](time_per_element.svg)
### Difference compared to For Each action in seconds
![time_per_element_difference](time_per_element_difference.svg)
### Average time per element in seconds
- For each with Condition: __0.095__
- Filter Array with For Each: __0.067__
- Inline code: __0.00049__

## Reflections

Before the results are to be analyzed it is important to mention, as I have done in an other benchmark [Choosing the Quickest Logic App Condition!üèéÔ∏è](https://www.antonbjorkman.com/posts/benchmark-condition), that the results are not to be seen at good or bad, there are many factor to consider and that can affect the performance. As for this benchmark we only focused on the duration of the workflows, this only gives us one slice of the pie. 

Right out the bat, the JavaScript implementation crushes its competition by being chockingly 194x faster than the For Each, and 134x faster than Filter Array implementation.  and to put this into prespective, if you have x amount of elements and on avg it takes y this means that you will endup with z. We can then calculate that the amount of time that could be saved by implementing JavaScript is around 99%. Should a Logic App process a lot of data? Perhaps no, but in a case where it is need the Javascript implementation should atleast be considered. 

Reason for this: JavaScript runs within a single execution context, minimizing the overhead associated with action-by-action processing.

Speedup of JavaScript compared to For Each: 193.88
Speedup of JavaScript compared to Filter Array: 136.73

For each action performs quite stable.
Filter array with For Each action seems to be more effective with lesser elements and the gradely decreases in performance.

The result from the benchmark tells us that JavaScript was the clear winner in terms of the performance. 
in an blog post from Microsoft it gives you tips in ways you can optimizes your workflow and etc...
https://techcommunity.microsoft.com/t5/azure-integration-services-blog/using-inline-code-instead-of-a-foreach-loop-for-better/ba-p/3369587

Does this mean that you always should do everything with JavaScript? No, probably you do want that and with a very large sized collection, consider chunking the array to smaler piecies and etc. 

Except for the performance we will also try and rate how eazy/hard it is to debug and development.

For anyone more interested in benchmark, I have made a similar test on a another topic rather condition actions [blog](/posts/benchmark-condition/). 